@model IEnumerable<ProyectoLuisa.Models.Horario>

@{
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    ViewData["Title"] = "Consulta y Gestión de Horarios";

    var colores = new[] { "primary", "success", "warning", "danger", "info", "secondary" };
    int colorIndex = 0;

    var horariosPorSeccion = Model
        .GroupBy(h => h.Seccion)
        .OrderBy(g => g.Key);

    // Diccionario enviado desde el controlador
    var docentes = ViewBag.Docentes as Dictionary<int, string>;
}

<div class="container mt-4 mb-5">
    <h2 class="text-center text-primary fw-bold mb-4">
        <i class="bi bi-clock-history"></i> Consulta y Gestión de Horarios
    </h2>

    <div class="d-flex justify-content-end mb-3">
        <a asp-action="Semanal" class="btn btn-outline-primary me-2 fw-bold">
            <i class="bi bi-calendar3"></i> Vista Semanal
        </a>

        <a asp-action="Crear" class="btn btn-success fw-bold">
            <i class="bi bi-plus-circle"></i> Nuevo Horario
        </a>
    </div>

    @if (!Model.Any())
    {
        <div class="alert alert-warning text-center">
            <i class="bi bi-exclamation-circle"></i> No hay horarios registrados.
        </div>
    }
    else
    {
        <div class="accordion" id="accordionHorarios">

            @foreach (var grupo in horariosPorSeccion)
            {
                var color = colores[colorIndex % colores.Length];
                colorIndex++;

                var collapseId = $"collapse_{grupo.Key?.Replace(" ", "_") ?? "SinSeccion"}";

                <div class="accordion-item mb-3 border-@color shadow-sm">

                    <h2 class="accordion-header" id="heading_@grupo.Key">
                        <button class="accordion-button collapsed fw-bold bg-@color text-white" type="button"
                                data-bs-toggle="collapse" data-bs-target="#@collapseId" aria-expanded="false"
                                aria-controls="@collapseId">
                            <i class="bi bi-book me-2"></i> Sección @grupo.Key
                        </button>
                    </h2>

                    <div id="@collapseId" class="accordion-collapse collapse" data-bs-parent="#accordionHorarios">

                        <div class="accordion-body bg-light">

                            <table class="table table-striped table-bordered text-center align-middle mb-0">

                                <thead class="table-@color text-white">
                                    <tr>
                                        <th>Materia</th>
                                        <th>Día</th>
                                        <th>Hora Inicio</th>
                                        <th>Hora Fin</th>
                                        <th>Aula</th>
                                        <th>Docente</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>

                                <tbody>
                                    @foreach (var h in grupo.OrderBy(h => h.DiaSemana).ThenBy(h => h.HoraInicio))
                                    {
                                        <tr>
                                            <td>@h.Materia</td>
                                            <td>@h.DiaSemana</td>
                                            <td>@h.HoraInicio.ToString(@"hh\:mm")</td>
                                            <td>@h.HoraFin.ToString(@"hh\:mm")</td>
                                            <td>@h.Aula</td>

                                            <td>
                                                @if (docentes != null && docentes.ContainsKey(h.DocenteId))
                                                {
                                                    @docentes[h.DocenteId]
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Sin asignar</span>
                                                }
                                            </td>

                                            <td>
                                                <a asp-action="Editar" asp-route-id="@h.Id" 
                                                   class="btn btn-warning btn-sm me-1">
                                                    <i class="bi bi-pencil-square"></i>
                                                </a>

                                                <form asp-action="Eliminar" asp-route-id="@h.Id" method="post" 
                                                      class="d-inline">
                                                    <button type="submit" class="btn btn-danger btn-sm"
                                                            onclick="return confirm('¿Deseas eliminar este horario?')">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    }
                                </tbody>

                            </table>

                        </div>

                    </div>

                </div>
            }

        </div>

    }

</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
}
