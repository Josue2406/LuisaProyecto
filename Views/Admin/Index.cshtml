@model IEnumerable<ProyectoLuisa.Models.Usuario>
@{
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    ViewData["Title"] = "Panel de Administraci贸n";
}

<div class="container mt-5">
    <h2 class="mb-4 text-center">Panel de Administraci贸n - Docentes</h2>

    <div class="d-flex justify-content-between mb-3">
        <a href="/Admin/CrearDocente" class="btn btn-success">
            <i class="bi bi-person-plus"></i> Nuevo Docente
        </a>
        <a href="/Roles" class="btn btn-outline-primary">Gestionar Roles</a>
        <a href="/Informacion/Index" class="btn btn-outline-success">
            <i class="bi bi-info-circle"></i> Informaci贸n Institucional
        </a>
        <a href="/Login" class="btn btn-secondary">Cerrar sesi贸n</a>
    </div>

    @if (TempData["Mensaje"] != null)
    {
        <div class="alert alert-success text-center">@TempData["Mensaje"]</div>
    }

    <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th>Nombre</th>
                <th>Correo</th>
                <th>Rol</th>
                <th>Estado</th>
                <th>Fecha Creaci贸n</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var docente in Model)
            {
                <tr>
                    <td>@docente.Nombre</td>
                    <td>@docente.Correo</td>
                    <td>@docente.Rol</td>
                    <td>
                        @if (docente.Activo)
                        {
                            <span class="badge bg-success">Activo</span>
                        }
                        else
                        {
                            <span class="badge bg-warning text-dark">Pendiente</span>
                        }
                    </td>
                    <td>@docente.FechaCreacion.ToString("dd/MM/yyyy")</td>
                    <td>
                        <!-- Bot贸n Editar -->
                        <button class="btn btn-sm btn-outline-primary me-2"
                                onclick="abrirModalEditar(@docente.Id, '@docente.Nombre', '@docente.Correo', '@docente.Rol')">
                            <i class="bi bi-pencil-square"></i> Editar
                        </button>

                        <!-- Bot贸n Reenviar invitaci贸n -->
                        <form asp-action="ReenviarInvitacion" method="post" style="display:inline">
                            <input type="hidden" name="id" value="@docente.Id" />
                            <button type="submit" class="btn btn-sm btn-outline-info">
                                <i class="bi bi-envelope"></i> Reenviar Invitaci贸n
                            </button>
                        </form>

                        <!-- Bot贸n Eliminar -->
                        <form asp-action="Eliminar" method="post" style="display:inline" onsubmit="return confirm('驴Seguro que quieres eliminar este docente?');">
                            <input type="hidden" name="id" value="@docente.Id" />
                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                <i class="bi bi-trash"></i> Eliminar
                            </button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @if (!Model.Any())
    {
        <p class="text-center mt-3 text-muted">No hay docentes registrados a煤n.</p>
    }
</div>

<!-- Ь MODAL EDITAR DOCENTE -->
<div class="modal fade" id="editarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">Editar Docente</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form id="editarForm">
                    <input type="hidden" id="docenteId" />
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Nombre completo</label>
                        <input type="text" id="docenteNombre" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Correo electr贸nico</label>
                        <input type="email" id="docenteCorreo" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Rol</label>
                        <select id="docenteRol" class="form-select" required>
                            <option value="Docente">Docente</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success fw-bold" onclick="guardarCambios()">
                    <i class="bi bi-save"></i> Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<script>
    let modalEditar;

    document.addEventListener("DOMContentLoaded", () => {
        modalEditar = new bootstrap.Modal(document.getElementById('editarModal'));
    });

    function abrirModalEditar(id, nombre, correo, rol) {
        document.getElementById("docenteId").value = id;
        document.getElementById("docenteNombre").value = nombre;
        document.getElementById("docenteCorreo").value = correo;
        document.getElementById("docenteRol").value = rol;
        modalEditar.show();
    }

    async function guardarCambios() {
        const id = document.getElementById("docenteId").value;
        const nombre = document.getElementById("docenteNombre").value;
        const correo = document.getElementById("docenteCorreo").value;
        const rol = document.getElementById("docenteRol").value;

        const resp = await fetch('/Admin/Editar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ id, nombre, correo, rol })
        });

        if (resp.ok) {
            modalEditar.hide();
            location.reload(); //  refresca la tabla
        } else {
            const msg = await resp.text();
            alert("Error: " + msg);
        }
    }
</script>

<style>
.modal-content {
    border-radius: 12px;
}
</style>
